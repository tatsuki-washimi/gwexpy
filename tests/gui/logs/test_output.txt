============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-7.4.0, pluggy-1.2.0
PyQt5 5.15.9 -- Qt runtime 5.15.8 -- Qt compiled 5.15.8
rootdir: /home/washimi/work/gwexpy
configfile: pytest.ini
collected 1 item

../../tests/nds/test_gui_nds_smoke.py This plugin does not support propagateSizeHints()
[Test Config] Mode: NDS2
[Test Config] Channels: ['L1:GDS-CALIB_STRAIN']
[Test Config] NDS Endpoint: k1nds2:31200
---- TEST TIMEOUT DIAGNOSTICS ----
Status Label: 
NDS Mode used: NDS2
NDS Server used in GUI: k1nds2:31200
Measurement Channels Active: ['L1:GDS-CALIB_STRAIN']
nds_latest_raw is None: True
----------------------------------
F

=================================== FAILURES ===================================
______________________________ test_gui_nds_smoke ______________________________

qtbot = <pytestqt.qtbot.QtBot object at 0x7d126019b0a0>
nds_backend = {'host': 'k1nds2', 'port': 31200}

    @pytest.mark.nds
    @pytest.mark.gui
    def test_gui_nds_smoke(qtbot, nds_backend):
        """
        Smoke test: Start app, connect to NDS, acquire data, ensure plot refresh.
        Includes enhanced diagnostics on timeout/failure.
        """
        # 1. Setup MainWindow
        window = MainWindow(enable_preload=False)
        qtbot.addWidget(window)
        window.show()
    
        # 2. Capture Error Signals
        last_error = []
        def on_error(msg):
            print(f"[GUI Error Signal] {msg}")
            last_error.append(msg)
    
        if hasattr(window, "nds_cache"):
            if hasattr(window.nds_cache, "signal_error"):
                window.nds_cache.signal_error.connect(on_error)
    
        # 3. Configure NDS Source (NDS vs NDS2 based on port)
        is_nds2 = (nds_backend["port"] == 31200)
        mode_str = "NDS2" if is_nds2 else "NDS"
        idx = window.input_controls["ds_combo"].findText(mode_str)
        if idx != -1:
            window.input_controls["ds_combo"].setCurrentIndex(idx)
    
        if is_nds2:
            window.input_controls["nds2_server"].setEditText(nds_backend["host"])
            window.input_controls["nds2_port"].setValue(nds_backend["port"])
        else:
            window.input_controls["nds_server"].setEditText(nds_backend["host"])
            window.input_controls["nds_port"].setValue(nds_backend["port"])
    
        # 4. Configure Channels
        test_channels_raw = os.getenv("GWEXPY_NDS_CHANNELS", "L1:GDS-CALIB_STRAIN")
        test_channels = [ch.strip() for ch in test_channels_raw.split(",")]
    
        print(f"[Test Config] Mode: {mode_str}")
        print(f"[Test Config] Channels: {test_channels}")
        print(f"[Test Config] NDS Endpoint: {nds_backend['host']}:{nds_backend['port']}")
    
        # Use a fresh list of dicts to avoid reference issues in set_all_channels
        new_states = [{"name": ch, "active": True} for ch in test_channels]
        window.meas_controls["set_all_channels"](new_states)
    
        # 5. Configure Measurement Duration/Averages (short settings for smoke test)
        window.meas_controls["averages"].setValue(1)
        window.meas_controls["bw"].setValue(1.0)  # 1Hz BW -> 1s FFT
        window.meas_controls["avg_type_fixed"].setChecked(True)
    
        # 6. Start Acquisition
        # Ensure acquisition loop starts (wait for first timer tick)
        with qtbot.waitSignal(window.timer.timeout, timeout=5000):
            qtbot.mouseClick(window.btn_start, QtCore.Qt.LeftButton)
    
        # 7. Wait for data updates
        def has_data():
            return window.nds_latest_raw is not None and len(window.nds_latest_raw) > 0
    
        try:
            qtbot.waitUntil(has_data, timeout=20000)  # Wait up to 20s for NDS data
        except Exception as e:
            # TIMEOUT: Print actionable state
            print("---- TEST TIMEOUT DIAGNOSTICS ----")
            print(f"Status Label: {window.status_label.text()}")
            if last_error:
                print(f"Last Error Signals: {last_error}")
    
            actual_mode = window.input_controls["ds_combo"].currentText()
            if actual_mode == "NDS2":
                srv = f"{window.input_controls['nds2_server'].currentText()}:{window.input_controls['nds2_port'].value()}"
            else:
                srv = f"{window.input_controls['nds_server'].currentText()}:{window.input_controls['nds_port'].value()}"
    
            print(f"NDS Mode used: {actual_mode}")
            print(f"NDS Server used in GUI: {srv}")
            print(f"Measurement Channels Active: {[s['name'] for s in window.meas_controls['channel_states'] if s['active']]}")
            print(f"nds_latest_raw is None: {window.nds_latest_raw is None}")
            print("----------------------------------")
>           raise e

../../tests/nds/test_gui_nds_smoke.py:88: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

qtbot = <pytestqt.qtbot.QtBot object at 0x7d126019b0a0>
nds_backend = {'host': 'k1nds2', 'port': 31200}

    @pytest.mark.nds
    @pytest.mark.gui
    def test_gui_nds_smoke(qtbot, nds_backend):
        """
        Smoke test: Start app, connect to NDS, acquire data, ensure plot refresh.
        Includes enhanced diagnostics on timeout/failure.
        """
        # 1. Setup MainWindow
        window = MainWindow(enable_preload=False)
        qtbot.addWidget(window)
        window.show()
    
        # 2. Capture Error Signals
        last_error = []
        def on_error(msg):
            print(f"[GUI Error Signal] {msg}")
            last_error.append(msg)
    
        if hasattr(window, "nds_cache"):
            if hasattr(window.nds_cache, "signal_error"):
                window.nds_cache.signal_error.connect(on_error)
    
        # 3. Configure NDS Source (NDS vs NDS2 based on port)
        is_nds2 = (nds_backend["port"] == 31200)
        mode_str = "NDS2" if is_nds2 else "NDS"
        idx = window.input_controls["ds_combo"].findText(mode_str)
        if idx != -1:
            window.input_controls["ds_combo"].setCurrentIndex(idx)
    
        if is_nds2:
            window.input_controls["nds2_server"].setEditText(nds_backend["host"])
            window.input_controls["nds2_port"].setValue(nds_backend["port"])
        else:
            window.input_controls["nds_server"].setEditText(nds_backend["host"])
            window.input_controls["nds_port"].setValue(nds_backend["port"])
    
        # 4. Configure Channels
        test_channels_raw = os.getenv("GWEXPY_NDS_CHANNELS", "L1:GDS-CALIB_STRAIN")
        test_channels = [ch.strip() for ch in test_channels_raw.split(",")]
    
        print(f"[Test Config] Mode: {mode_str}")
        print(f"[Test Config] Channels: {test_channels}")
        print(f"[Test Config] NDS Endpoint: {nds_backend['host']}:{nds_backend['port']}")
    
        # Use a fresh list of dicts to avoid reference issues in set_all_channels
        new_states = [{"name": ch, "active": True} for ch in test_channels]
        window.meas_controls["set_all_channels"](new_states)
    
        # 5. Configure Measurement Duration/Averages (short settings for smoke test)
        window.meas_controls["averages"].setValue(1)
        window.meas_controls["bw"].setValue(1.0)  # 1Hz BW -> 1s FFT
        window.meas_controls["avg_type_fixed"].setChecked(True)
    
        # 6. Start Acquisition
        # Ensure acquisition loop starts (wait for first timer tick)
        with qtbot.waitSignal(window.timer.timeout, timeout=5000):
            qtbot.mouseClick(window.btn_start, QtCore.Qt.LeftButton)
    
        # 7. Wait for data updates
        def has_data():
            return window.nds_latest_raw is not None and len(window.nds_latest_raw) > 0
    
        try:
>           qtbot.waitUntil(has_data, timeout=20000)  # Wait up to 20s for NDS data
E           pytestqt.exceptions.TimeoutError: waitUntil timed out in 20000 milliseconds

../../tests/nds/test_gui_nds_smoke.py:69: TimeoutError
=============================== warnings summary ===============================
../../../../mambaforge/lib/python3.10/site-packages/scitokens/utils/keycache.py:9
  /home/washimi/mambaforge/lib/python3.10/site-packages/scitokens/utils/keycache.py:9: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
    import pkg_resources  # part of setuptools

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED ../../tests/nds/test_gui_nds_smoke.py::test_gui_nds_smoke - pytestqt.e...
======================== 1 failed, 1 warning in 28.51s =========================
