# STLT 技術レポート: 実装ノートと現状レビュー

本ドキュメントは、STLT (Short-Time Laplace Transform) に関する文献調査に基づく実装上の注意点（Implementation Notes）と、現在の `gwexpy` コードベースのレビュー結果（Implementation Review）をまとめたものです。

## 1. 実装ノート (Implementation Notes)

### 1.1 数学的定義

STLTは、通常の短時間フーリエ変換（STFT）のカーネル $e^{-j\omega t}$ を、複素数 $s = \sigma + j\omega$ に拡張したものです。
時間領域での実装としては、各ウィンドウ内の信号 $h(t)$ に対して減衰項 $e^{-\sigma t}$ を乗じてから FFT を行うことと等価です。

$$ \tilde{h}_{STLT}(t, \sigma, \omega) = \int_{-\infty}^{\infty} h(\tau) w(\tau - t) e^{-\sigma \tau} e^{-j\omega \tau} d\tau $$

ここで、$\sigma$ はラプラス変数 $s$ の実部を表し、減衰率に対応します。

### 1.2 推奨パラメータと設定

* **ラプラス変数 ($\sigma$)**: 解析対象（例: ブラックホールのリングダウン信号）の減衰時定数に近い値を探索範囲として設定します。正の値は減衰、負の値は増幅に対応します。
* **Time Reference**: 指数関数 $e^{-\sigma t}$ は時間の経過とともに急激に増大（または減少）するため、数値計算上のオーバーフローを防ぐため、ウィンドウの中央を時刻 $t=0$ とする (`time_ref='center'`) 設定が推奨されます。

## 2. 現状の実装レビュー (Implementation Review)

対象ファイル: `gwexpy/timeseries/_spectral_special.py` (`TimeSeries.stlt` メソッド)

### 2.1 評価できる点 (Pros)

* **ベクトル化 (Vectorized Implementation)**:
    複数の $\sigma$ 値を一度に渡すことができ、内部で `numpy` のブロードキャストを用いて一括計算しているため、ループ処理に比べて高速です。
* **数値安定性 (Stability)**:
    `time_ref='center'` オプションが実装されており、さらに指数部の最大値 (`max_exponent`) が 700 を超える場合に `ValueError` を送出するガードレールも実装されています。これにより、不適切なパラメータによる予期せぬオーバーフローを防いでいます。
* **バッチ処理**:
    メモリ使用量を抑制するため、チャンク方向のループ処理（バッチ処理）が実装されています。

### 2.2 課題・バグ (Issues/Bugs)

* ✅ **`frequencies` の任意周波数評価に対応（解消済み）**:
  * **旧状況**: `frequencies` を指定しても FFT グリッド固定で無視される制限がありました。
  * **現状**: `frequencies` を指定すると、その周波数（Hz）で STLT を評価して返します（任意周波数点に対応）。
  * **実装上のポイント**:
    * FFT グリッド一致の場合は FFT を計算して該当 bin を抽出（高速）。
    * 等間隔グリッドの場合は自動で最適化（規模に応じて切替）:
      * 小規模（例: 256点以下）: direct DFT（位相行列の事前計算キャッシュあり）。
      * 大規模: `scipy.signal.zoom_fft` を使用。
    * 不規則な周波数リストは direct DFT（周波数方向もチャンク）で評価。
  * **備考**: 範囲外周波数や不正な `scaling` などは `ValueError` で明示的に失敗します。

### 2.3 その他の観察事項

* **Legacy Mode**: 古い実装 (`_stlt_legacy`) へのパスが残されていますが、デフォルトでは新しいベクトル化実装が使用されます。

## 3. 結論と推奨

現在の `stlt` 実装は、数値的な安定性と効率性を重視して設計されており、文献にある理論とも整合しています。また、`frequencies` を指定した任意周波数での評価にも対応したため、用途（狙い周波数・帯域ズーム・任意点）に応じた解析が可能です。
