# pyaggui 開発計画書

**作成日:** 2026-01-22
**対象:** `gwexpy/gui/pyaggui.py` および `gwexpy` コアライブラリ
**参照:** DTT Analysis Reports (dtt_subsystem_reports.md, dtt_analysis_report.md, analyze_pyaggui_implementation.md)

---

## 1. ビジョンと目標

`pyaggui` の目標は、LIGO/KAGRAの標準診断ツールである **DTT (Diagnostic Test Tools)** の機能を Python (`gwexpy`) 上で完全に再現し、さらに現代的なUIと拡張性（シミュレーション、PCオーディオなど）を付加することである。

最終的には、C++版の DTT (`diaggui`) を置き換え可能なレベルの信頼性と機能性を持たせることを目指す。

### 1.1 安全性の基本方針

**重要:** 本開発では、実験装置への予期せぬ影響を防ぐため、以下の安全原則を遵守する：

*   **AWG（波形生成器）制御は当面シミュレーションのみ**: 実ハードウェアへの波形出力機能は実装しない。
*   **ハードウェアインターフェースの分離**: 将来的なハードウェア連携に備え、インターフェースは別モジュールとして設計するが、デフォルトでは無効化する。
*   **データ読み取り専用モード**: NDS2 からのデータ取得は読み取り専用とし、実験システムへの書き込みは行わない。

## 2. 現状とギャップ分析

### 2.1 実装済みの機能 (Strength)
*   **モダンなUI**: Qt (PySide6) ベースのタブ切り替え型インターフェース。
*   **基本解析**: FFT, PSD, CSD, Coherence の計算と表示。
*   **グラフ機能**: `pyqtgraph` を用いた高速描画、X軸同期、カーソル、単位変換。
*   **シミュレーション**: 内部信号生成器によるリアルタイム波形表示。
*   **設定UI**: チャンネル選択、ウィンドウ関数、平均化設定などのパラメータ入力画面。

### 2.2 未実装・課題 (Weakness / Gap)
*   **Swept Sine (周波数掃引測定)**: DTTの核心機能の一つだが、gwexpy/pyaggui ともに未実装。
*   **Zoom FFT**: ヘテロダイン変換による高分解能解析ロジックが欠如。
*   **NDS2 リアルタイム接続**: 基本的な接続はあるが、長時間の安定性やバッファ処理が DTT ほど堅牢ではない可能性。
*   **AWG (励起信号) 制御**: 外部ハードウェアへの信号注入ロジックが実装されていない（現在は内部シミュレーションのみ）。
*   **データ検証**: 計算結果（PSDの正規化係数など）が DTT とビット単位で一致するか検証されていない。
*   **保存/復元**: 測定設定やグラフ状態の保存フォーマット（JSON/XML）が未整備。

---

## 3. 開発ロードマップ

開発を4つのフェーズに分割し、段階的に DTT の機能を統合していく。

### Phase 1: コアロジックの検証と基盤強化 (1-2週間)

既存のFFT解析機能が DTT と物理的に等価であることを保証する。

*   **Task 1.1: PSD/CSD 正規化の検証**
    *   DTT の `ffttools.cc` における `windowBW` (ENBW) 補正と `scipy.signal.welch` の出力を比較テスト。
    *   必要に応じて `gwexpy.signal.spectral` モジュールを修正。
*   **Task 1.2: MeasurementState スキーマの定義**
    *   GUI の設定値（周波数範囲、平均回数、チャンネル等）を保持するデータクラス `MeasurementState` を作成。
    *   JSON へのシリアライズ/デシリアライズ機能を実装し、設定の保存を可能にする。
*   **Task 1.3: DTT XML 互換性**
    *   既存の `dttxml` パッケージを利用し、DTT で保存された測定データを `pyaggui` で読み込んで表示できるようにする。

### Phase 2: Swept Sine (伝達関数測定) の実装 (3-4週間)

制御系の同定に不可欠な Swept Sine 測定機能を実装する。

*   **Task 2.1: Swept Sine シミュレーション**
    *   `gwexpy` に `SweptSineMeasurement` クラスを実装。
    *   `scipy.signal.chirp` 等を用いた掃引信号生成と、同期検波（Lock-in Detection）による振幅・位相推定ロジックの実装。
*   **Task 2.2: GUI 統合**
    *   Measurement タブに "Swept Sine" モードを追加。
    *   開始/終了周波数、点数、セトリング時間の設定UIを追加。
    *   Bode Plot (振幅・位相) のリアルタイム更新表示。

### Phase 3: 高度な解析機能とデータ処理 (2-3週間)

DTT の「痒い所に手が届く」機能を実装する。

*   **Task 3.1: Zoom FFT**
    *   周波数シフト（ヘテロダイン）とデシメーションを行う `zoom_fft` 関数を `gwexpy` に実装。
    *   GUI から中心周波数と帯域幅を指定して実行できるようにする。
*   **Task 3.2: 単位変換の拡充**
    *   キャリブレーションデータ（伝達関数モデル）を適用し、[Ct] -> [m] などの単位変換をリアルタイムで行う機能。
*   **Task 3.3: バーストノイズ測定**
    *   トリガー機能とゲーティング（励起信号の断続出力）ロジックの実装。

### Phase 4: バックエンド統合と高度なシミュレーション (4週間〜)

実運用環境での安定稼働と、より高度なシミュレーション機能を実装する。

*   **Task 4.1: NDS2 ライブストリーミングの堅牢化**
    *   `nds2-client` python バインディングを用いた、途切れのないデータストリーミングクラスの再設計。
    *   バッファリングと遅延処理の最適化。
    *   長時間測定時のメモリ管理と自動再接続機能。
*   **Task 4.2: AWG シミュレーション機能の拡張**
    *   **注意: 安全性のため、実ハードウェアへの出力は行わない。シミュレーションのみ実装。**
    *   より複雑な波形生成アルゴリズム（任意波形の読み込み、合成など）。
    *   GUI の Excitation タブで設定した波形をリアルタイムで可視化。
    *   波形データのエクスポート機能（将来的な外部AWG制御への準備）。
    *   **ハードウェアインターフェースは別モジュールとして分離し、デフォルトでは無効化。**
*   **Task 4.3: Foton 連携**
    *   フィルタ設計ツール `foton` で作成したフィルタ係数ファイル (`.txt`) を読み込む機能。
    *   リアルタイムフィルタリング（IIR SOS形式）のシミュレーションと可視化。
    *   フィルタ適用前後の信号比較表示。

---

## 4. 技術的指針 (Technical Guidelines)

### 4.1 アーキテクチャ原則
*   **分離 (Decoupling)**: GUI (`pyaggui`) と計算ロジック (`gwexpy`) を明確に分離する。GUI はパラメータを渡し、`gwexpy` が計算を行い、結果（`FrequencySeries` 等）を返す。
*   **状態管理**: 全ての設定は `MeasurementState` (Pydantic モデル推奨) で管理し、UI の状態とデータの状態が乖離しないようにする。
*   **非同期処理**: データ取得や重い計算はメインスレッド（UIスレッド）をブロックしないよう、`QThread` または `concurrent.futures` で実行する。

### 4.2 テスト戦略
*   **単体テスト**: `gwexpy` に追加する計算ロジック（Swept Sine, Zoom FFT）は必ず単体テストで数学的な正しさを検証する。
*   **比較テスト**: 可能であれば、DTT の出力データ（CSV/XML）をテストケースとして取り込み、Python 版の計算結果と比較する。
*   **UIテスト**: `pytest-qt` を使用して、ボタン操作やタブ切り替え時の挙動を自動テストする。

---

## 5. 次のアクション

まず **Phase 1** に着手する。具体的には以下のタスクから開始することを推奨する。

1.  `tests/signal/test_spectral_agreement.py` を作成し、DTT と同一パラメータでの PSD 計算結果を検証する。
2.  `gwexpy/measurements/` パッケージを作成し、測定ロジックを管理する基底クラスを設計する。

