# Field4D 向け信号処理拡張 計画書 (2026-01-21 17:51:40)

- 元ファイル: `docs/developers/plans/Signal Processing Extensions for Field4D: PSD, Correlation and Coherence Utilities.docx`
- 変換: `pandoc -f docx -t gfm`

## 使用モデルとリソース最適化

- 実装（API設計・コア計算・既存コードへの統合）: `Claude Opus 4.5`
- テスト以降（pytest/CI/回帰・最終調整）: `GPT-5.1-Codex-Max`
- 補助モデル: 要約/文章整形/単純置換などは軽量モデルへ切替
- リソース戦略: 変更対象ファイルと該当箇所を絞って提示、差分ベースで反復、長文ログ/全ファイル貼付は避ける

---

# Field4D フェーズ3：信号処理拡張 計画

本計画は、**Field4D** に信号処理ユーティリティを追加するために必要なタスクを整理したものです。目的は、4D データセットに対してスペクトル解析、相関、コヒーレンス、遅延推定を行うためのツールを研究者に提供しつつ、これまでのフェーズで確立した設計原則（軸メタデータ、4D 形状の保持、単位の整合性）を維持することです。実装は、コアとなる計算メソッドと薄い描画ラッパーを中心に、包括的なテストとドキュメントを伴って進めます。

## 目的

- PSD（パワースペクトル密度）推定と周波数–空間マッピングにより、Field4D データの周波数領域解析を可能にする
- 信号伝搬の解析に向けて、相関と遅延のツール（相互相関・時間遅延マップ）を提供する
- 空間領域全体で信号の類似性を定量化するため、コヒーレンス（コヒーレンス・マップ）を実装する
- 計算と可視化の分離を維持する（計算関数は再利用可能なオブジェクトを返し、描画は薄いラッパーで扱う）
- 再現可能性のため、決定論的な例とテストを用意する

## タスク

### 1. 共通の下準備

1.  **デモデータ生成**

2.  固定シードと既知の波形（例：伝搬するガウシアン波、正弦波など）を用いて、決定論的な Field4D を生成するヘルパー関数（例：`make_demo_field4d`）を実装する

3.  単位と軸メタデータ（時間軸・空間軸）が正しく付与されることを確認する

4.  ノートブック・Examples・テストでこの関数を使用し、再現性を保証する

5.  **座標ユーティリティ（Phase 2 の再利用）**

6.  最寄りインデックス変換とスライス・ヘルパーが、不規則な時間ベクトル／周波数でも動作できることを確認する（Welch PSD に必要）

7.  適切な箇所で `select_value` ヘルパーを拡張し、スペクトルパワー選択（例：`mode="power"`）をサポートする

### 2. パワースペクトル密度（PSD）

1.  **計算**: `compute_psd(point_or_region, *, nperseg, noverlap, window, detrend)`

2.  `scipy.signal.welch` を用いて、単一点または空間領域から抽出した時系列の PSD を推定する

3.  返り値は、単一点なら `FrequencySeries`、複数点／領域なら `FrequencySeriesList` とする

4.  時間軸が等間隔サンプリングであることを検証し、満たされない場合は説明的なエラーを送出する

5.  領域指定はスライスまたはマスクで受け付け、必要に応じて点間平均（任意）を可能にする

6.  **周波数–空間マップ**: `freq_space_map(axis, at, *, method="welch", **kwargs)`

7.  ある空間軸（例：x）に沿って、他の座標を固定しつつ各位置で PSD を計算する

8.  一方の軸が周波数、もう一方の軸が空間座標となる 2D 行列を生成する

9.  下流の描画へ渡しやすい形として、`Array2D` もしくは `Field4D` の view を返す

10. 明確化のため `compute_freq_space` などの別名も提供する

11. **描画ラッパー**: `plot_psd` / `plot_freq_space`

12. 計算関数を呼び出して Matplotlib で描画する薄いラッパーを実装する

13. ラベル表記（周波数[Hz]、PSD）を統一し、対数スケール等のオプションも提供する

14. **テスト**

15. 合成正弦波で PSD をテストし、ピーク周波数とパワーレベルを検証する

16. ホワイトノイズの PSD が概ねフラットになることを確認する

17. `freq_space_map` が期待する shape と軸メタデータを返すことを検証する

### 3. 相互相関と遅延推定

1.  **相互相関**: `compute_xcorr(point_a, point_b, *, max_lag, mode)`

2.  2 つの時系列間の正規化相互相関関数を計算する

3.  `'full'` / `'same'` 等のモードを許可し、ラグ軸をもつ `TimeSeries` を返す

4.  相関前の detrend／window 適用をオプション化する

5.  **時間遅延マップ**: `time_delay_map(ref_point, plane, *, max_lag, stride, roi)`

6.  参照点と 2D スライス上の全点の相互相関を計算する

7.  相関が最大（または絶対値最大）となるラグを抽出し、スカラー値のマップとして格納する

8.  計算コスト管理のため、stride と ROI（region-of-interest）指定を受け付ける

9.  遅延値を保持する `Field4D` スライスを返す

10. **描画ラッパー**: `plot_xcorr` / `plot_delay_map`

11. Matplotlib で相関関数と遅延マップを可視化する簡易ラッパーを提供する

12. ピーク遅延の注釈や、有意領域の強調などのオプションを用意する

13. **テスト**

14. 既知の時間シフトを持つ合成信号で推定ラグを検証する

15. 遅延マップが滑らかであること、stride/ROI が計算を軽くしつつピークラグ値を変えないことを確認する

### 4. コヒーレンス解析

1.  **コヒーレンス計算**: `coherence_map(ref_point, *, band, nperseg, noverlap, window)`

2.  参照信号と、全 3D 領域または 2D スライス上の各点の信号との間で、二乗コヒーレンス（magnitude-squared coherence）を計算する

3.  周波数帯 `[fmin, fmax]` 上で平均し、空間点ごとの単一スカラー値にするオプションを提供する

4.  バンドごとの計算か複数バンドかに応じて、`Field4D` もしくは `Field4DDict` を返す

5.  **描画ラッパー**: `plot_coherence_map`

6.  コヒーレンス・マップを 2D ヒートマップとして表示する

7.  カラーノーマライズ変更や高コヒーレンス領域の注釈などのオプションを提供する

8.  **テスト**

9.  位相関係が既知の合成信号でコヒーレンス計算を検証する

10. バンド平均や正規化が想定通りに振る舞うことを確認する

### 5. ドキュメントと例

1.  **チュートリアル・ノートブック**

2.  デモデータセット上で PSD、周波数–空間マップ、相互相関、遅延マップ、コヒーレンス解析を実演する `Field4D_signal_processing.ipynb` を新規作成する

3.  テストを再現できる説明文とコードセルを含め、正しい利用パターンを示す

4.  決定論的データを用いて再現性を担保する

5.  **リファレンス・ドキュメント**

6.  追加する各メソッドについて、目的・パラメータ・返り値・例・計算コスト上の注意点を含む API ドキュメントを書く

7.  英語／日本語の index に新機能を追加する

8.  Field4D の 1D/2D プロットと、新しい信号処理プロットの差分を強調する

9.  **Examples ディレクトリ**

10. `examples/` に、`matplotlib.backends.backend_agg` を用いて新しいプロットの静的画像を生成するスクリプトを追加する（テストとデモ用途）

11. プロット種別の選択と保存先指定のための CLI オプションを提供する

### 6. テストと検証

1.  **自動テスト**

2.  pytest スイートを拡充し、新規関数をそれぞれカバーする

3.  エッジケース（例：非等間隔サンプリング、空領域、ゼロ信号）を含むテストを追加する

4.  前提条件（等間隔サンプリングなど）が満たされない場合に適切な例外が送出されることを確認する

5.  **性能面の考慮**

6.  計算負荷が高い関数（例：`time_delay_map`、`coherence_map`）をプロファイルし、stride/ROI オプションを実装する

7.  代表的なユースケースでベンチマークし、デフォルトパラメータが対話利用に適切であることを確認する

8.  **継続的インテグレーション**

9.  新しいテストを既存の CI ワークフローへ統合する

10. CI 条件下でノートブックが end-to-end で実行できることを検証する

## 英語タイトル案

**“Signal Processing Extensions for Field4D: PSD, Correlation and Coherence Utilities”**

このタイトルは、Field4D にスペクトル解析と相関解析ツールを拡張するフェーズ3の要点を簡潔に表現しています。
