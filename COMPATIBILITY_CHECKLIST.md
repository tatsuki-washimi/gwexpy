# gwpy 互換性調査・検証リスト

`gwexpy` が `gwpy` のドロップインリプレースメントとして機能するかについての調査状況です。

## 1. 確認済み事項 (Confirmed)
静的解析および簡易スクリプト（`verify_compatibility.py`）により、以下の挙動を確認しました。

*   **[TimeSeries/FrequencySeries] コンストラクタ互換性**: 
    *   GPS時刻への自動変換（`t0`, `epoch`）および不要なキーワード引数（`fmin`, `fmax` 等）のサイレント除去が機能している。
*   **[TimeSeries/FrequencySeries] 型の継承**:
    *   `crop()`, `append()`, `fft()`, `ifft()` 等の操作後も、戻り値が `gwexpy` のクラスであることを維持している。
*   **[Plot] 視覚的等価性**:
    *   `adaptive_decimate` (Min/Maxアルゴリズム) により、データ間引き後もスパイク（極値）が視覚的に保存される。
*   **[Plot] 二重描画の抑制**:
    *   `_repr_html_ = None` により、Jupyter Notebook上での意図しない二重描画が抑制されている。
*   **[Plot] リソース管理**:
    *   `show()` 実行後に `plt.close()` が呼ばれ、メモリリークが防止されている。

## 2. 要検証リスト (To-be-verified List)
実際の運用環境やエッジケースにおいて、さらなる確認が必要な事項です。

### 2.1 Jupyter環境での描画フォールバック
*   **内容**: `_repr_html_` を無効化した際、IPython/Jupyterが正しく `_repr_png_` や `_repr_svg_` にフォールバックして画像を表示するか。
*   **懸念**: 一部の環境で「セルにオブジェクトを置いても何も表示されない」状態にならないか確認が必要。

### 2.2 大規模データでのプロット性能とメモリ
*   **内容**: 数千万点を超える極端に巨大な `TimeSeries` を描画しようとした際の `adaptive_decimate` の計算コスト。
*   **懸念**: 間引き処理自体がボトルネックになったり、一時的な配列作成でメモリ不足にならないか。

### 2.3 単位が混在する場合の Plot ラベル挙動
*   **内容**: 単位が異なる複数のシリーズを一つの `Plot` に渡した際、`gwexpy` はグローバルな `ylabel` の設定をスキップするロジックがある。
*   **懸念**: `gwpy` のデフォルト挙動（最初のデータの単位を採用する等）と視覚的な差異が出ないか。

### 2.4 `ifft(mode="auto")` の判定ロジック
*   **内容**: `_gwex_fft_mode` 属性に基づいた自動切替が、意図しないケース（ユーザーが手動で属性を触った場合など）で誤作動しないか。

### 2.5 外部ライブラリとの相互運用 (Interop)
*   **内容**: `to_pandas()`, `to_torch()`, `to_xarray()` 等の戻り値が、`gwpy` 版の出力と構造的に等価か。
*   **懸念**: メタデータ（名前や単位）の保持方法に差異がないか。

### 2.6 スライシング・演算後の内部属性維持 (`__array_finalize__`)
*   **内容**: `gwexpy` は `FrequencySeries` 等に `_gwex_fft_mode` などの内部属性を持たせているが、`__array_finalize__` が実装されていない可能性がある。
*   **懸念**: `fs2 = fs[10:20]` や `fs2 = fs * 2.0` のような操作を行った際、新しいオブジェクトにこれらの内部属性が引き継がれず、`ifft(mode='auto')` が期待通り動作しなくなる（デフォルトのgwpyモードに戻ってしまう）リスクがある。
