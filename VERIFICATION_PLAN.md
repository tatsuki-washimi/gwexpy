# gwpy 互換性検証計画

`gwexpy` プロジェクトにおいて、`gwpy` からの移行（`from gwpy...` -> `from gwexpy...`）が完全な互換性を持ち、かつ結果が等しくなることを検証するための計画書です。

静的解析（ソースコードリーディング）の結果、以下の項目について挙動の差異や互換性の懸念が特定されました。これらを重点的に検証する必要があります。

## 1. 懸念事項と検証ポイント

### 1.1 `TimeSeries` / `FrequencySeries` のコンストラクタ (`__new__`)

*   **現状**: `gwexpy` のクラスは、`gwpy` の親クラスに渡す前に特定のキーワード引数（`fmin`, `fmax`, `df` など）を `kwargs` から削除したり、`t0`, `epoch` を GPS 時刻に強制変換したりする処理が含まれています。
*   **懸念**: `gwpy` で本来エラーになるべき引数が無視されてエラーにならなかったり、逆に `gwpy` が受け付ける形式の引数が予期せず変換されてしまう可能性があります。
*   **検証**:
    *   `gwpy` でエラーになる不要な引数（例: `fmin`）を渡したときの挙動比較。
    *   `t0` に文字列や `datetime` オブジェクトを渡したときの挙動比較。

### 1.2 `Plot` クラスの自動デシメーション（間引き）



*   **現状**: `gwexpy.plot.Plot` は、データ点数が多い場合（デフォルト: > 50,000点）、自動的に `adaptive_decimate` を適用しています。実装は Min/Max 間引き（各ビンの最小・最大を抽出）であり、視覚的なエンベロープを保存する意図があります。

*   **懸念**: Min/Max 間引きは振幅を保存しますが、時間軸は簡易的に等間隔化されています。これにより、スパイクの位置がわずかにズレたり、特定の周期パターンでのモアレが発生したりしないか確認が必要です。

*   **検証（ゴール：視覚的に差異がないこと）**:

    *   **スパイク保存テスト**: 背景ノイズの中に単発の大きなスパイク（インパルス）を埋め込んだデータをプロットし、間引かれた状態でもスパイクの高さが維持されているか確認する。

    *   **拡大時の挙動**: ズームイン操作をした場合、間引きデータが再計算されないと荒いままになるが、静止画としての初期表示の一致を確認する。



### 1.3 `Plot.show()` と二重描画抑制の副作用

*   **現状**: `gwpy` の Jupyter における二重描画バグを回避するため、`_repr_html_ = None` とし、`show()` メソッド内で `plt.close(self)` を実行しています。
*   **懸念**:
    *   `_repr_html_` を無効化したことで、特定の環境で画像が全く表示されなくなる（`_repr_png_` へのフォールバックが失敗する）可能性。
    *   `show()` 呼出し後に `savefig()` を行うようなスクリプトで、図が閉じられているためにエラーになる、あるいは白紙が保存される可能性。
*   **検証**:
    *   **表示確認**: `_repr_png_` が有効なデータを返すか確認する。
    *   **保存確認**: `plot.show()` -> `plot.savefig('test.png')` のシーケンスを実行し、エラーの有無と保存された内容を確認する。

### 1.4 メソッドの戻り値の型 (Type Preservation)

*   **現状**: `append`, `crop`, `ifft` などのメソッドがオーバーライドされています。
*   **懸念**: これらのメソッドが返すオブジェクトの型が、期待通り `gwexpy` のクラスになっているか、あるいは `gwpy` のクラスに戻ってしまっていないか（「型落ち」していないか）。また、`inplace` 操作時の挙動が一致しているか。
*   **検証**:
    *   `ts = gwexpy.TimeSeries(...)` に対して `ts.crop(...)`, `ts.append(...)` を行った結果の `type()` を確認。
    *   `ifft` の `mode="gwpy"` (デフォルト) 時の戻り値確認。

### 1.5 `ifft` メソッドのデフォルト挙動

*   **現状**: `FrequencySeries.ifft` は `mode="auto"` をデフォルトとし、内部状態 `_gwex_fft_mode` をチェックしています。
*   **懸念**: 通常使用では `gwpy` 互換になるはずですが、エッジケースで `transient` モードが誤発火しないか確認が必要です。
*   **検証**:
    *   通常の `FrequencySeries` に対して `ifft()` を呼び出し、`gwpy` の結果と数値的に完全に一致するか確認。

## 2. 検証用スクリプトの作成方針

以下の検証スクリプトを作成し、実行することを推奨します。

### `verify_compatibility.py`

このスクリプトは以下のテストケースを実行します：

1.  **コンストラクタ互換性テスト**:
    *   `gwpy` と `gwexpy` で同じ引数を与えてオブジェクトを生成し、属性（`t0`, `dt`, `unit`, `value`）が完全に一致するかアサートする。
2.  **プロット間引きテスト**:
    *   長さ $N=10^6$ のランダムデータを生成。
    *   `gwpy.plot.Plot(ts)` と `gwexpy.plot.Plot(ts)` を生成。
    *   生成された `Lines` オブジェクトのデータ点数を比較（`gwpy` は $10^6$、`gwexpy` は `decimate_points` 以下になっているはず）。
    *   **判定基準**: デフォルトで挙動が違うことは「仕様」として許容するか、互換性のために無効化すべきかを判断する材料とする。
3.  **Plot ライフサイクルテスト**:
    *   `show()` 後の操作可否を try-except で確認。
4.  **演算・加工メソッドテスト**:
    *   `crop`, `append` 後の型チェック。
    *   `ifft` の数値誤差チェック（`np.allclose`）。

## 3. ドキュメント化と対応

検証の結果、意図的な「拡張による差異」と判断された場合は、ユーザーガイド（移行ガイド）に明記する必要があります。
特に **プロットの間引き** はユーザーが気づかないうちにデータが見えなくなるリスクがあるため、明示的なドキュメント化またはデフォルト設定の再考（`gwpy` 完全互換モードの導入など）が必要です。
