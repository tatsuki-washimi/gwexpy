# `ScalarField` テストカバレッジの強化 計画書 (2026-01-22 21:53:41)

## 目的
`ScalarField` APIのテストスイートを拡張・堅牢化し、サポートされているすべての操作において、正確なドメイン伝播、単位の一貫性、およびメタデータの完全性を保証する。

## 作業範囲

### 1. ドメイン伝播テスト (最優先事項)
以下のケースにおいて、ドメインメタデータが正しく保持、変換、または拒否されることを検証する：
- 完全なFFTおよび逆FFT (iFFT)
- 軸のサブセットに対する部分的なFFT
- FFT / iFFT サイクルの繰り返し
- データのスライシング、クロッピング、サブセッティング
- 連鎖的な操作 (例: スライス → FFT → スライス)
- **検証項目**: ドメインタイプ (時間、周波数、空間など)、軸の順序とラベル、グリッド間隔、物理적意味の整合性。

### 2. 単位の一貫性と検証
以下の事項を保証するためのテストを強化する：
- すべてのサポートされている変換における単位の正しい伝播。
- FFT操作における単位のスケーリングと正規化の正確な適用。
- 無効または矛盾する単位の組み合わせに対する明示的な例外スロー。
- 誤った単位の使用に対するネガティブテスト。

### 3. メタデータの完全性
`ScalarField`がメタデータを正しく保持・更新することを検証する：
- スライスや変換後も軸記述子が維持されていること。
- 明示的に破棄されない限り、カスタムメタデータフィールドが保持されていること。
- メタデータのクローン作成と参照の正確さ (意図しないミューテーションの防止)。
- メタデータを考慮した等価性比較セマンティクス。

### 4. 境界条件とエッジケース
以下のエッジ条件に対する回帰テストを追加する：
- 長さゼロまたはシングルトン(長さ1)の軸。
- 非連続なスライス。
- 特殊なFFTサイズ (長さ1、素数サイズなど)。
- NaN / Inf の処理。
- 空または最小限のメタデータ辞書。

### 5. テスト構造と配置
- `tests/fields/` 配下の以下のファイルを更新または作成する：
    - `test_scalarfield_domain.py`
    - `test_scalarfield_fft.py`
    - `test_scalarfield_units.py`
- pytestスタイルの明示的なアサーションを使用する。

## 品質ゲート (合格必須)
- `pytest` がすべて成功すること (新規のskipやxfailがないこと)。
- `mypy .` がパスすること。
- `ruff check` がパスすること。
- テスト失敗時のメッセージが具体的で解決に役立つこと。

## 受理基準
- 主要なすべての操作が正常系・異常系テストでカバーされていること。
- ドメインや単位のエラーがユーザー報告ではなくテストで検出されること。
- テストコード内にレガシーな `Field4D` や過去の互換性に関する言及がないこと。
- テストスイート自体が `ScalarField` の意図した物理的・数学的セマンティクスを文書化していること。

## 使用モデルとリソース最適化

### 推奨モデル
- **モデル**: `Claude Sonnet 4.5`
- **理由**: 論理的な検証とユニットテストの実装において高い信頼性があり、コンテキスト消費のバランスが良いため。

### リソース管理戦略
- **クオータ管理**: テストケースの実装を適切にグループ化し、ファイル書き込みとテスト実行のサイクルを最小限に抑えることでトークンを節約する。
- **コンテキスト最適化**: 関連するソースコードの断片のみを参照し、不要な履歴の蓄積を避ける。
